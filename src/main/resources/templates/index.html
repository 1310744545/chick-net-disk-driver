<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>é…ç½®</title>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- import Vue before Element -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        .el-row {
            margin-bottom: 20px;

        &
        :last-child {
            margin-bottom: 0;
        }

        }
        .el-col {
            border-radius: 4px;
        }

        .bg-purple-dark {
            background: #99a9bf;
        }

        .bg-purple {
            background: #d3dce6;
        }

        .bg-purple-light {
            background: #e5e9f2;
        }

        .grid-content {
            border-radius: 4px;
            min-height: 36px;
        }

        .row-bg {
            padding: 10px 0;
            background-color: #f9fafc;
        }

        .el-card__body {
            padding: 15px;
        }

        .el-progress-bar {
            width: 80%;
        }
    </style>
</head>
<body>
<div id="app" style="text-align: center;padding: 20px 40px;width: 80%;margin: 0 auto">
    <h2> ğŸ‘‡å¯æ·»åŠ ç½‘ç›˜åˆ—è¡¨ğŸ‘‡ ç‚¹å‡»æ·»åŠ  (é™†ç»­å¼€å‘ä¸­)</h2>
    <el-divider></el-divider>
    <el-row :gutter="20">
        <el-col :span="6" v-for="item in supportedNetDisk" :key="item.index">
            <a href="javascript:;" style="text-decoration:none" @click="addNetDisk(item.name)">
                <el-card shadow="hover" style="margin: 0 0 20px 0;padding: 0;vertical-align: middle;">
                    <el-image
                            style="width: 50px; height: 50px;vertical-align:middle"
                            :src="item.icon"
                            fit="fill"></el-image>
                    <span style="font-size: 30px;line-height: 50px;display: inline-block;vertical-align: middle;">
                    &nbsp;&nbsp;{{item.name}}
                </span>
                </el-card>
            </a>
        </el-col>
    </el-row>
    <el-divider></el-divider>
    <br>
    <h2> ğŸ‘‡å·²æ·»åŠ ç½‘ç›˜åˆ—è¡¨ğŸ‘‡ </h2>
    <el-divider></el-divider>
    <el-table
            :data="registerNetDisks"
            style="width: 100%">
        <el-table-column
                label="å›¾æ ‡"
                width="80">
            <template slot-scope="scope">
                <el-image style="width: 30px; height: 30px;vertical-align:middle" :src="scope.row.icon"
                          fit="fill"></el-image>
            </template>
        </el-table-column>
        <el-table-column
                prop="netDiskName"
                label="ç½‘ç›˜å"
                width="120">
        </el-table-column>
        <el-table-column
                prop="avatar"
                width="80"
                label="ç”¨æˆ·å¤´åƒ">
            <template slot-scope="scope">
                <el-image style="width: 30px; height: 30px;vertical-align:middle" :src="scope.row.avatar"
                          fit="fill"></el-image>
            </template>
        </el-table-column>
        <el-table-column
                prop="userName"
                width="150"
                label="ç™»å½•ç”¨æˆ·">
        </el-table-column>
        <el-table-column
                prop="capacity"
                width="600"
                label="å®¹é‡">
            <template slot-scope="scope">
                <div>
                    <el-progress :stroke-width="12"
                                 :percentage="calculateRate(scope.row.capacityTotal, scope.row.capacityUsed)"
                                 :format="format(scope.row.capacityTotal, scope.row.capacityUsed)"></el-progress>
                </div>
            </template>
        </el-table-column>
        <el-table-column
                prop="path"
                width="120"
                label="åŸºç¡€è·¯å¾„">
        </el-table-column>
        <el-table-column
                width="300"
                fixed="right"
                label="æ“ä½œ">
            <template slot-scope="scope">
                <el-button v-on:click="editPath(scope.row.path)" size="small" type="primary">ç¼–è¾‘</el-button>
                <el-popconfirm title="ç¡®å®šåˆ é™¤å—ï¼Ÿ" @confirm="deletePath(scope.row.path)">
                    <el-button size="small" type="danger" slot="reference">åˆ é™¤</el-button>
                </el-popconfirm>
<!--                <el-button v-on:click="deletePath(scope.row.path)" size="small" type="danger">åˆ é™¤</el-button>-->
                <el-button v-on:click="goBase('/'+scope.row.path)" size="small" type="primary">è·³è½¬è‡³æ ¹è·¯å¾„ <i
                        class="el-icon-position"></i></el-button>
            </template>
        </el-table-column>
    </el-table>
    <el-dialog :title="netDiskNameNow" :visible.sync="dialogFormVisible" width="30%" v-loading="loading"
               :close-on-click-modal="false">
        <span> ğŸ‘‡è¯·é€‰æ‹©ç™»å½•æ–¹å¼ğŸ‘‡ (é™†ç»­å¼€å‘ä¸­)</span>
        <br>
        <br>
        <el-tabs v-model="loginTypeNow" type="card">
            <br>
            <br>
            <el-tab-pane v-if="loginTypes.indexOf('refreshToken') !== -1" label="refreshToken" name="refreshToken">
                <el-form label-width="120px" ref="refreshToken" :rules="refreshTokenRules" :model="refreshTokenFrom">
                    <el-form-item label="refreshToken" prop="refreshToken" style="width: 90%">
                        <el-input v-model="refreshTokenFrom.refreshToken"></el-input>
                    </el-form-item>
                </el-form>
            </el-tab-pane>
            <el-tab-pane v-if="loginTypes.indexOf('password') !== -1" label="password" name="password">
                <el-form label-width="120px" ref="password" :rules="passwordRules" :model="passwordFrom">
                    <el-form-item label="è´¦å·" prop="username" style="width: 90%">
                        <el-input v-model="passwordFrom.username"></el-input>
                    </el-form-item>
                    <el-form-item label="å¯†ç " prop="password" style="width: 90%">
                        <el-input v-model="passwordFrom.password"></el-input>
                    </el-form-item>
                </el-form>
            </el-tab-pane>
            <el-tab-pane v-if="loginTypes.indexOf('qrcode') !== -1" label="qrcode" name="qrcode">
                <el-form label-width="120px">
                    qrcode
                </el-form>
            </el-tab-pane>
            <el-tab-pane v-if="loginTypes.indexOf('sms') !== -1" label="sms" name="sms">
                <el-form label-width="120px" ref="sms" :rules="smsRules">
                    <el-form-item label="sms" prop="sms" style="width: 90%">
                        <el-input v-model="sms"></el-input>
                    </el-form-item>
                </el-form>
            </el-tab-pane>
        </el-tabs>
        <div slot="footer" class="dialog-footer">
            <el-button @click="dialogFormVisible = false">å– æ¶ˆ</el-button>
            <el-button type="primary" @click="netDiskRegister()">ç¡® å®š</el-button>
        </div>
    </el-dialog>
    <el-dialog title="åŸºç¡€è·¯å¾„" :visible.sync="dialogEditPath" width="30%" :close-on-click-modal="false">
        <el-input v-model="editPathStr"></el-input>
        <br>
        <br>
        <el-button @click="dialogEditPath = false">å– æ¶ˆ</el-button>
        <el-button type="primary" @click="submitEditPath()">ç¡® å®š</el-button>
    </el-dialog>
</div>
</body>
<script>
    new Vue({
        el: '#app',
        data: {
            localhostPath: '',
            supportedNetDisk: {},
            loginTypes: [],
            loginTypeNow: '',
            netDiskNameNow: '',
            sms: '',
            dialogFormVisible: false,
            dialogEditPath: false,
            editPathOriginalStr: '',
            editPathStr: '',
            refreshTokenFrom: {
                refreshToken: '',
            },
            passwordFrom: {
                username: '',
                password: '',
            },
            loading: false,
            registerNetDisks: [],
            refreshTokenRules: {
                refreshToken: [
                    {required: true, message: 'è¯·è¾“å…¥refreshToken', trigger: 'blur'}
                ]
            },
            passwordRules: {
                username: [
                    {required: true, message: 'è¯·è¾“å…¥è´¦å·', trigger: 'blur'}
                ],
                password: [
                    {required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur'}
                ]
            },
            smsRules: {
                sms: [
                    {required: true, message: 'è¯·è¾“å…¥æ‰‹æœºå·', trigger: 'blur'}
                ]
            },
        },
        methods: {
            getLocalHost() {
                var curWwwPath = window.document.location.href;
                var pathname = window.document.location.pathname;
                var pos = curWwwPath.indexOf(pathname);
                this.localhostPath = curWwwPath.substring(0, pos);
            },
            getSupportedNetDisk() {
                var this_ = this;
                axios.post(this.localhostPath + '/system/diskList').then(function (res) {
                    if (res.data.code == 1) {
                        this_.$message.error(res.data.msg);
                        return;
                    }
                    this_.supportedNetDisk = res.data.data;
                })
            },
            addNetDisk(netDiskName) {
                this.netDiskNameNow = netDiskName;
                this.dialogFormVisible = true;
                var this_ = this;
                var data = new URLSearchParams()
                data.append('netDiskName', netDiskName)
                axios.post(this.localhostPath + '/system/loginTypes', data).then(function (res) {
                    if (res.data.code == 1) {
                        this_.$message.error(res.data.msg);
                        return;
                    }
                    this_.loginTypes = res.data.data;
                    this_.loginTypeNow = res.data.data[0];
                })
            },
            netDiskRegister() {
                if ('refreshToken' === this.loginTypeNow) {
                    this.$refs['refreshToken'].validate(valid => {
                        if (!valid) {
                            return;
                        }
                    })
                }
                if ('password' === this.loginTypeNow) {
                    this.$refs['password'].validate(valid => {
                        if (!valid) {
                            return;
                        }
                    })
                }
                if ('sms' === this.loginTypeNow) {
                    this.$refs['sms'].validate(valid => {
                        if (!valid) {
                            return;
                        }
                    })
                }
                this.loading = true;
                var this_ = this;
                var data = new URLSearchParams()
                data.append('username', this.passwordFrom.username);
                data.append('password', this.passwordFrom.password);
                data.append('refreshToken', this.refreshTokenFrom.refreshToken);
                data.append('accessToken', '');
                data.append('name', this.netDiskNameNow);
                data.append('loginType', this.loginTypeNow);
                axios.post(this.localhostPath + '/system/netDiskRegister', data).then(function (res) {
                    if (res.data.code == 1) {
                        this_.$message.error(res.data.msg);
                        return;
                    }
                    this_.$message.success('ç™»å½•ç½‘ç›˜æˆåŠŸ');
                    this_.loadRegisterNetDisk();
                    this_.loading = false;
                    this_.dialogFormVisible = false
                })
            },
            loadRegisterNetDisk() {
                var this_ = this;
                axios.post(this.localhostPath + '/system/registerNetDisk').then(function (res) {
                    if (res.data.code == 1) {
                        this_.$message.error(res.data.msg);
                        return;
                    }
                    this_.registerNetDisks = res.data.data;
                    console.log(this_.registerNetDisks)
                })
            },
            calculateRate(total, used) {
                if (total === 0 || used === 0) {
                    return 0
                }
                return parseInt(used / total * 100);
            },
            format(total, used) {
                return () => {
                    total = total / 1024 / 1024 / 1024 > 1024 ? (total / 1024 / 1024 / 1024 / 1024).toFixed(2) + "TB" : (total / 1024 / 1024 / 1024).toFixed(2) + "GB";
                    used = total.indexOf('TB') !== -1 ? (used / 1024 / 1024 / 1024 / 1024).toFixed(2) + "TB" : (used / 1024 / 1024 / 1024).toFixed(2) + "GB";
                    return used + "/" + total;
                }
            },
            goBase(path) {
                window.open(path, '_blank');
            },
            editPath(path) {
                this.dialogEditPath = true;
                this.editPathStr = path;
                this.editPathOriginalStr = path;
            },
            submitEditPath() {
                var this_ = this;
                var data = new URLSearchParams();
                data.append('editPathOriginalStr', this.editPathOriginalStr);
                data.append('editPathStr', this.editPathStr);
                axios.post(this.localhostPath + '/system/submitEditPath', data).then(function (res) {
                    if (res.data.code == 1) {
                        this_.$message.error(res.data.msg);
                        return;
                    }
                    this_.$message.success('ä¿®æ”¹æˆåŠŸ');
                    this_.loadRegisterNetDisk();
                    this_.dialogEditPath = false;
                })
            },
            deletePath(path) {
                var this_ = this;
                axios.post(this.localhostPath + '/system/deletePath?path=' + path).then(function (res) {
                    if (res.data.code == 1) {
                        this_.$message.error(res.data.msg);
                        return;
                    }
                    this_.$message.success('åˆ é™¤æˆåŠŸ');
                    this_.loadRegisterNetDisk();
                })
            }
        },
        created() {
            this.getSupportedNetDisk();
            this.getLocalHost();
            this.loadRegisterNetDisk();
        }
    })
</script>
<script>
    var curWwwPath = window.document.location.href;
    var pathname = window.document.location.pathname;
    var pos = curWwwPath.indexOf(pathname);
    var localhostPath = curWwwPath.substring(0, pos);
    var loginTypes;
    var loginTypeNow;
    var netDiskNameNow;
    window.onload = function () {
        // åŠ è½½æ”¯æŒçš„ç½‘ç›˜
        // loadSupportNetDisk()
        // åŠ è½½å·²ç»ç™»å½•çš„ç½‘ç›˜
        // loadAddEdNetDisk()
    }

    function loadRegisterNetDisk() {
        diskStr = '';
        $.ajax({
            url: localhostPath + '/system/loginEdDiskList',
            type: 'post',
            success: function (res) {
                console.log(res)
            }
        });
    }
</script>
</html>
